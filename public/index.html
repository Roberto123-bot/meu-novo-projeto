<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de Combina√ß√µes</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        background: #f4f4f9;
        color: #333;
        max-width: 600px;
        margin: 20px auto;
      }
      h1 {
        text-align: center;
        color: #4a4a4a;
      }

      /* --- NOVO CSS (Status) --- */
      #statusDisplay {
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 8px;
      }
      .status-open {
        color: #218838;
        background-color: #d4edda;
      }
      .status-closed {
        color: #c82333;
        background-color: #f8d7da;
      }
      /* --- FIM DO NOVO CSS --- */

      form {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      #nome {
        grid-column: 1 / -1;
      }
      input,
      button {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 0;
      }
      button[type="submit"] {
        grid-column: 1 / -1;
        background: #007aff;
        color: white;
        font-weight: bold;
        cursor: pointer;
        border: none;
      }
      button[type="submit"]:hover {
        background: #0056b3;
      }

      /* --- CSS dos Bot√µes de Admin --- */
      .admin-button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }

      #copyButton {
        grid-column: 1 / -1; /* Ocupa a linha toda */
        background: #28a745;
        color: white;
      }

      /* --- NOVO CSS (Bot√£o Status) --- */
      #toggleButton {
        background: #ffc107; /* Amarelo */
        color: #212529; /* Texto escuro */
      }
      #toggleButton:hover {
        background: #e0a800;
      }

      #clearButton {
        background: #dc3545; /* Vermelho */
        color: white;
      }
      #clearButton:hover {
        background: #c82333;
      }

      /* Estilo comum para bot√µes de admin */
      #copyButton,
      #clearButton,
      #toggleButton {
        display: block;
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
      }
      /* --- FIM DO NOVO CSS --- */

      ul {
        list-style: none;
        padding: 0;
      }
      li {
        background: white;
        padding: 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1em;
        word-break: break-word;
      }
      li strong {
        color: #007aff;
      }
      li span {
        font-family: monospace, monospace;
        font-size: 1.2em;
        font-weight: bold;
        padding-left: 10px;
      }
      .admin-buttons {
        display: flex;
        gap: 8px;
        padding-left: 10px;
      }
      .admin-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
      }
      .edit-btn {
        color: #ffc107;
      }
      .delete-btn {
        color: #dc3545;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }
      #editForm {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      #editNome {
        grid-column: 1 / -1;
      }
      #saveEditButton {
        grid-column: 1 / -1;
      }
      #closeModalButton {
        background-color: #aaa;
        grid-column: 1 / -1;
      }

      @media (max-width: 500px) {
        body {
          margin: 0;
          padding: 10px;
        }
        form,
        #editForm {
          grid-template-columns: 1fr;
        }
        li {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .admin-buttons {
          align-self: flex-end;
        }

        /* Ajusta bot√µes admin para 1 coluna no celular */
        .admin-button-group {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <h1>üí° Lista de Combina√ß√µes</h1>

    <form id="form">
      <input type="text" id="nome" placeholder="Seu nome" required />
      <input type="number" id="n1" min="1" max="25" placeholder="N1" required />
      <input type="number" id="n2" min="1" max="25" placeholder="N2" required />
      <input type="number" id="n3" min="1" max="25" placeholder="N3" required />
      <button type="submit">Salvar</button>
    </form>

    <div class="admin-button-group">
      <button id="copyButton">Copiar Lista</button>
      <button id="toggleButton">Alternar Status (Admin)</button>
      <button id="clearButton">‚ùå Limpar Lista (Admin)</button>
    </div>
    <ul id="lista"></ul>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h2>Editar Combina√ß√£o</h2>
        <form id="editForm">
          <input type="hidden" id="editId" />
          <input type="text" id="editNome" placeholder="Seu nome" required />
          <input
            type="number"
            id="editN1"
            min="1"
            max="60"
            placeholder="N1"
            required
          />
          <input
            type="number"
            id="editN2"
            min="1"
            max="60"
            placeholder="N2"
            required
          />
          <input
            type="number"
            id="editN3"
            min="1"
            max="60"
            placeholder="N3"
            required
          />
          <button type="submit" id="saveEditButton">Salvar Mudan√ßas</button>
          <button type="button" id="closeModalButton">Cancelar</button>
        </form>
      </div>
    </div>

    <script>
      const backendURL = "https://meu-novo-projeto-production.up.railway.app"; // Lembre de trocar

      let dadosAtuais = [];
      let currentStatus = "open"; // --- NOVA VARI√ÅVEL JS (Estado)

      const socket = io(backendURL);
      const listaEl = document.getElementById("lista");
      const formEl = document.getElementById("form");
      const copyButton = document.getElementById("copyButton");
      const clearButton = document.getElementById("clearButton");
      const statusDisplay = document.getElementById("statusDisplay"); // --- NOVA
      const toggleButton = document.getElementById("toggleButton"); // --- NOVA

      const editModal = document.getElementById("editModal");
      const editForm = document.getElementById("editForm");
      const closeModalButton = document.getElementById("closeModalButton");

      // --- NOVO LISTENER (Socket.io de Status) ---
      socket.on("statusUpdate", (status) => {
        console.log("Novo status recebido:", status);
        currentStatus = status; // Salva o estado atual
        if (status === "open") {
          statusDisplay.innerText = "LISTA ABERTA ‚úÖ";
          statusDisplay.className = "status-open";
          // Reabilita o formul√°rio
          formEl.querySelector("button").disabled = false;
          formEl.querySelector("button").innerText = "Salvar";
        } else {
          statusDisplay.innerText = "LISTA FECHADA ‚ùå";
          statusDisplay.className = "status-closed";
          // Desabilita o formul√°rio
          formEl.querySelector("button").disabled = true;
          formEl.querySelector("button").innerText = "Lista Fechada";
        }
      });
      // --- FIM DO NOVO LISTENER ---

      // --- PARTE A: Receber dados (Socket.io) ---
      socket.on("update", (dados) => {
        dados.reverse(); // <<<--- ADICIONE ESTA LINHA

        dadosAtuais = dados;
        listaEl.innerHTML = "";

        dados.forEach((item) => {
          const li = document.createElement("li");

          li.dataset.id = item.id;
          li.dataset.nome = item.nome;
          li.dataset.n1 = item.n1;
          li.dataset.n2 = item.n2;
          li.dataset.n3 = item.n3;

          li.innerHTML = `
            <div>
              <strong>${item.nome}</strong> 
              <br>
              <span>${item.n1}, ${item.n2}, ${item.n3}</span>
            </div>
            <div class="admin-buttons">
              <button class="admin-btn edit-btn">‚úèÔ∏è</button>
              <button class="admin-btn delete-btn">‚ùå</button>
            </div>
          `;
          listaEl.appendChild(li);
        });
      });

      // --- PARTE B: Envio de Formul√°rio (POST) ---
      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        // --- VERIFICA√á√ÉO DE STATUS (Dupla checagem) ---
        if (currentStatus === "closed") {
          alert("A lista de combina√ß√µes est√° FECHADA no momento.");
          return; // Para a execu√ß√£o
        }
        // --- FIM DA VERIFICA√á√ÉO ---

        const nome = document.getElementById("nome").value;
        const n1 = document.getElementById("n1").value;
        const n2 = document.getElementById("n2").value;
        const n3 = document.getElementById("n3").value;

        try {
          const res = await fetch(backendURL + "/combinacoes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, n1, n2, n3 }),
          });

          if (!res.ok) {
            // Se o servidor recusar (lista fechada), avisa o usu√°rio
            const errorData = await res.json();
            alert(errorData.error || "N√£o foi poss√≠vel salvar.");
          } else {
            formEl.reset();
          }
        } catch (err) {
          alert("Erro ao conectar com o servidor.");
        }
      });

      // --- PARTE C: L√≥gica de Copiar ---
      copyButton.addEventListener("click", () => {
        if (dadosAtuais.length === 0) {
          copyButton.innerText = "Lista vazia!";
          setTimeout(() => (copyButton.innerText = "Copiar Lista"), 2000);
          return;
        }

        const titulo = `(‚óûÍàç‚àáÍàç)„Å£üéÅ ùô±ùöÅùô∏ùôΩùô≤ùô∞ùô≥ùô¥ùô∏ùöÅùô∞ùöÇ ùô≥ùô∞ùöÇ ùôµùô∞ùôªùô∑ùô∞ùöÇ (‚ùõ0‚ùõ‚ãÜ)

üéØùêÄùêúùêûùê´ùê≠ùêû ùüë ùêùùêûùê≥ùêûùêßùêöùê¨ ùê™ùêÆùêû ùêß√£ùê® ùê¢ùê´√£ùê® ùêØùê¢ùê¶ ùêßùêö ùê•ùê®ùê≠ùê®ùêüùêöùêúùê¢ùê• ùê°ùê®ùê£ùêû ùüëùüìùüèùüì

üéÅùêÜùêÄùêçùêáùêÄ ùüèùüéùüé ùêÅùêàùêãùêáùêÑùêìùêÑùêí ùêÉùêÄ ùêëùêàùêÖùêÄ ùêÑ ùêåùêÄùêàùêí ùüí ùêèùêàùêó ùêèùêÑùêãùêÄ ùêãùêéùêìùêÑùêëùêàùêÄ ùêÖùêÑùêÉùêÑùêëùêÄùêã

`;

        // --- MUDAN√áA DA FORMATA√á√ÉO DA LISTA ---
        const listaFormatada = dadosAtuais
          .map((item, index) => {
            // "index" come√ßa em 0, ent√£o adicionamos 1
            const numero = index + 1;
            // Adicionamos o n√∫mero e um ponto antes do nome
            return `${numero}. ${item.nome}:\t${item.n1}, ${item.n2}, ${item.n3}`;
          })
          .join("\n");
        // --- FIM DA MUDAN√áA ---

        navigator.clipboard.writeText(titulo + listaFormatada).then(() => {
          copyButton.innerText = "Copiado! üëç";
          setTimeout(() => {
            copyButton.innerText = "Copiar Lista";
          }, 2000);
        });
      });

      // --- PARTE D: L√ìGICA DE ADMIN (EDITAR E DELETAR) ---
      function getAdminPassword() {
        return prompt("Digite a senha de Admin:");
      }

      listaEl.addEventListener("click", async (e) => {
        const target = e.target;
        const li = target.closest("li");
        if (!li) return;

        const id = li.dataset.id;

        // Deletar
        if (target.classList.contains("delete-btn")) {
          if (!confirm(`Tem certeza que quer deletar "${li.dataset.nome}"?`)) {
            return;
          }
          const password = getAdminPassword();
          if (!password) return;

          try {
            const res = await fetch(`${backendURL}/combinacoes/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ adminPassword: password }),
            });
            if (!res.ok) alert("Senha incorreta ou erro no servidor.");
          } catch (err) {
            alert("Erro ao deletar.");
          }
        }

        // Editar (Abrir Modal)
        if (target.classList.contains("edit-btn")) {
          document.getElementById("editId").value = id;
          document.getElementById("editNome").value = li.dataset.nome;
          document.getElementById("editN1").value = li.dataset.n1;
          document.getElementById("editN2").value = li.dataset.n2;
          document.getElementById("editN3").value = li.dataset.n3;
          editModal.style.display = "block";
        }
      });

      // Fechar Modal
      closeModalButton.addEventListener("click", () => {
        editModal.style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target == editModal) {
          editModal.style.display = "none";
        }
      });

      // Salvar Edi√ß√£o
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const password = getAdminPassword();
        if (!password) return;

        const id = document.getElementById("editId").value;
        const dados = {
          nome: document.getElementById("editNome").value,
          n1: document.getElementById("editN1").value,
          n2: document.getElementById("editN2").value,
          n3: document.getElementById("editN3").value,
          adminPassword: password,
        };

        try {
          const res = await fetch(`${backendURL}/combinacoes/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
          });
          if (!res.ok) {
            alert("Senha incorreta ou erro ao salvar.");
          } else {
            editModal.style.display = "none";
          }
        } catch (err) {
          alert("Erro ao salvar.");
        }
      });

      // --- NOVA L√ìGICA JS (Limpar Lista) ---
      clearButton.addEventListener("click", async () => {
        // 1. Confirma√ß√£o Dupla (MUITO IMPORTANTE)
        if (!confirm("TEM CERTEZA que quer deletar TODA a lista?")) {
          return;
        }
        if (!confirm("Confirma√ß√£o final. Isso n√£o pode ser desfeito.")) {
          return;
        }

        // 2. Pede a senha
        const password = getAdminPassword(); // Reusa a fun√ß√£o
        if (!password) return;

        // 3. Envia a requisi√ß√£o
        try {
          const res = await fetch(`${backendURL}/combinacoes/all`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ adminPassword: password }),
          });

          if (!res.ok) {
            alert("Senha incorreta ou erro no servidor.");
          }
          // Se der certo, o socket.io vai atualizar a lista
          // para todos automaticamente (n√£o precisamos fazer nada aqui).
        } catch (err) {
          alert("Erro ao limpar a lista.");
        }
      });

      // --- NOVA L√ìGICA JS (Alternar Status) ---
      toggleButton.addEventListener("click", async () => {
        const password = getAdminPassword();
        if (!password) return;

        try {
          const res = await fetch(`${backendURL}/toggle-status`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ adminPassword: password }),
          });
          if (!res.ok) {
            alert("Senha incorreta ou erro no servidor.");
          }
          // Se der certo, o socket.io vai atualizar o status
          // para todos automaticamente.
        } catch (err) {
          alert("Erro ao alternar status.");
        }
      });
      // --- FIM DA NOVA L√ìGICA ---
    </script>
  </body>
</html>
